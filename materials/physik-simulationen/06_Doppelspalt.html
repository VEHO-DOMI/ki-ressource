<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doppelspaltexperiment - Quantenphysik Interaktiv</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #05051a 0%, #0a0a2e 50%, #150530 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
        }

        /* Animated background */
        .quantum-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .quantum-wave {
            position: absolute;
            border-radius: 50%;
            border: 1px solid rgba(171, 71, 188, 0.1);
            animation: wave-expand 8s infinite ease-out;
        }

        @keyframes wave-expand {
            0% { transform: scale(0); opacity: 0.5; }
            100% { transform: scale(4); opacity: 0; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #ab47bc, #7c4dff, #00bcd4);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle { color: rgba(255,255,255,0.5); font-weight: 300; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 25px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        /* Simulation Area */
        .simulation-area {
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(171, 71, 188, 0.2);
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 16px;
            background: radial-gradient(ellipse at 20% 50%, #0a0a20 0%, #050510 100%);
            border: 1px solid rgba(171, 71, 188, 0.2);
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 14px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 15px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            color: rgba(255,255,255,0.6);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .mode-btn.active {
            background: rgba(171, 71, 188, 0.2);
            border-color: #ab47bc;
            color: #ab47bc;
        }

        .mode-icon {
            font-size: 1.3em;
        }

        /* Intensity Graph */
        .intensity-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 14px;
        }

        .intensity-title {
            font-size: 0.8em;
            color: rgba(255,255,255,0.5);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #intensityCanvas {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }

        /* Detector Alert */
        .detector-alert {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 12px;
        }

        .detector-alert.visible {
            display: block;
            animation: pulse-alert 2s infinite;
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .detector-alert h4 {
            color: #e74c3c;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detector-alert p {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
        }

        /* Quantum Explanation */
        .quantum-insight {
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(171, 71, 188, 0.1), rgba(0, 188, 212, 0.05));
            border-radius: 14px;
            border-left: 4px solid #ab47bc;
        }

        .quantum-insight h4 {
            color: #ab47bc;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .quantum-insight p {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
            line-height: 1.6;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(171, 71, 188, 0.15);
            padding: 22px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .panel-title {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 15px;
        }

        /* Particle Selector */
        .particle-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .particle-btn {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .particle-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .particle-btn.active {
            border-color: #ab47bc;
            background: rgba(171, 71, 188, 0.2);
        }

        .particle-btn .icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }

        .particle-btn .name {
            font-size: 0.85em;
            color: rgba(255,255,255,0.8);
        }

        .particle-btn .wavelength {
            font-size: 0.7em;
            color: rgba(255,255,255,0.4);
            margin-top: 3px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #ab47bc;
        }

        .stat-label {
            font-size: 0.65em;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Sliders */
        .slider-group {
            margin: 15px 0;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.7);
        }

        .slider-value {
            font-weight: 600;
            color: #ab47bc;
            font-family: 'Courier New', monospace;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #7c4dff, #ab47bc);
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Wavelength slider with color */
        #wavelength {
            background: linear-gradient(90deg,
                #8b00ff 0%, #0000ff 15%, #00ffff 30%,
                #00ff00 45%, #ffff00 60%, #ff7f00 75%, #ff0000 100%);
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover { transform: translateY(-2px); }

        .btn.primary {
            background: linear-gradient(135deg, #ab47bc, #7c4dff);
            color: white;
            box-shadow: 0 8px 25px rgba(171, 71, 188, 0.3);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }

        .btn.detector {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn.detector.active {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        /* Checkboxes */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
        }

        .toggle-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .toggle-switch {
            width: 40px;
            height: 22px;
            background: rgba(255,255,255,0.2);
            border-radius: 11px;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-row.active .toggle-switch {
            background: #ab47bc;
        }

        .toggle-row.active .toggle-switch::after {
            left: 21px;
        }

        .toggle-label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.7);
        }

        /* Speed Control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .speed-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-btn.active {
            background: #ab47bc;
        }

        /* Info Footer */
        .info-footer {
            margin-top: 25px;
            padding: 22px;
            background: linear-gradient(135deg, rgba(171, 71, 188, 0.08), rgba(0, 188, 212, 0.05));
            border-radius: 18px;
            border-left: 4px solid #ab47bc;
        }

        .info-footer h3 {
            color: #ab47bc;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .info-footer p {
            color: rgba(255,255,255,0.6);
            line-height: 1.7;
            font-size: 0.9em;
        }

        /* Formula Display */
        .formula-box {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #ab47bc;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="quantum-bg" id="quantumBg"></div>

    <div class="container">
        <header>
            <h1>Doppelspaltexperiment</h1>
            <p class="subtitle">Entdecke das Geheimnis der Quantenphysik ‚Äì Welle oder Teilchen?</p>
        </header>

        <div class="main-grid">
            <div class="simulation-area">
                <canvas id="mainCanvas" width="800" height="500"></canvas>

                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="double">
                        <span class="mode-icon">‚ïë‚ïë</span>
                        <span>Doppelspalt</span>
                    </button>
                    <button class="mode-btn" data-mode="single">
                        <span class="mode-icon">‚îÇ</span>
                        <span>Einzelspalt</span>
                    </button>
                    <button class="mode-btn" data-mode="compare">
                        <span class="mode-icon">‚ü∑</span>
                        <span>Vergleich</span>
                    </button>
                </div>

                <div class="detector-alert" id="detectorAlert">
                    <h4>üîç Welcher-Weg-Detektor AKTIV</h4>
                    <p>Das Interferenzmuster verschwindet! Wenn wir messen, durch welchen Spalt das Teilchen geht,
                    verh√§lt es sich wie ein klassisches Teilchen ‚Äì die Wellennatur kollabiert.</p>
                </div>

                <div class="intensity-section">
                    <div class="intensity-title">üìä Intensit√§tsverteilung am Schirm</div>
                    <canvas id="intensityCanvas"></canvas>
                </div>

                <div class="quantum-insight" id="quantumInsight">
                    <h4>üí° Quantenmechanische Erkenntnis</h4>
                    <p id="insightText">Einzelne Photonen erzeugen zuf√§llige Punkte auf dem Schirm.
                    Aber √ºber viele Teilchen entsteht ein Interferenzmuster ‚Äì als w√ºrde jedes Teilchen
                    gleichzeitig durch beide Spalte gehen!</p>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel-title">üî¨ Teilchenquelle</div>
                <div class="particle-selector">
                    <button class="particle-btn active" data-particle="photon">
                        <span class="icon">üí°</span>
                        <span class="name">Photonen</span>
                        <span class="wavelength">Œª variabel</span>
                    </button>
                    <button class="particle-btn" data-particle="electron">
                        <span class="icon">‚ö°</span>
                        <span class="name">Elektronen</span>
                        <span class="wavelength">de Broglie Œª</span>
                    </button>
                </div>

                <div class="panel-title">üìä Statistik</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="slit1Count">0</div>
                        <div class="stat-label">Spalt 1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="slit2Count">0</div>
                        <div class="stat-label">Spalt 2</div>
                    </div>
                </div>

                <div class="panel-title">‚öôÔ∏è Parameter</div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">üåà Wellenl√§nge Œª</span>
                        <span class="slider-value" id="wavelengthVal">550 nm</span>
                    </div>
                    <input type="range" id="wavelength" min="380" max="700" value="550">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">‚ÜîÔ∏è Spaltabstand d</span>
                        <span class="slider-value" id="slitDistanceVal">0.5 mm</span>
                    </div>
                    <input type="range" id="slitDistance" min="20" max="100" value="50">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">üìè Spaltbreite b</span>
                        <span class="slider-value" id="slitWidthVal">0.1 mm</span>
                    </div>
                    <input type="range" id="slitWidth" min="3" max="25" value="10">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">‚ö° Emissionsrate</span>
                        <span class="slider-value" id="rateVal">Mittel</span>
                    </div>
                    <input type="range" id="emissionRate" min="1" max="10" value="5">
                </div>

                <div class="panel-title">üéõÔ∏è Optionen</div>

                <div class="toggle-row active" id="toggleWaves" onclick="toggleOption('waves')">
                    <div class="toggle-switch"></div>
                    <span class="toggle-label">Wellenausbreitung zeigen</span>
                </div>

                <div class="toggle-row" id="toggleProbability" onclick="toggleOption('probability')">
                    <div class="toggle-switch"></div>
                    <span class="toggle-label">Wahrscheinlichkeitsverteilung</span>
                </div>

                <div class="btn-row">
                    <button class="btn primary" id="playBtn" onclick="togglePlay()">‚ñ∂ Starten</button>
                    <button class="btn secondary" onclick="resetExperiment()">‚Ü∫ Reset</button>
                </div>

                <div class="btn-row">
                    <button class="btn detector" id="detectorBtn" onclick="toggleDetector()">
                        üîç Detektor AN
                    </button>
                </div>

                <div class="speed-control">
                    <span style="font-size: 0.8em; color: rgba(255,255,255,0.5);">Tempo:</span>
                    <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                    <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                    <button class="speed-btn" onclick="setSpeed(5)">5x</button>
                </div>

                <div class="formula-box">
                    Œîy = Œª ¬∑ L / d
                </div>
            </div>
        </div>

        <div class="info-footer">
            <h3>üìö Der Welle-Teilchen-Dualismus</h3>
            <p>Das Doppelspaltexperiment zeigt eines der gr√∂√üten Geheimnisse der Physik:
            <strong>Quantenobjekte sind weder reine Wellen noch reine Teilchen</strong>.
            Ein einzelnes Photon geht "irgendwie" durch beide Spalte gleichzeitig und interferiert mit sich selbst!
            Aber sobald wir messen, durch welchen Spalt es geht, verschwindet das Interferenzmuster.
            Die <strong>Beobachtung ver√§ndert das System</strong> ‚Äì ein fundamentales Prinzip der Quantenphysik.</p>
        </div>
    </div>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const intensityCanvas = document.getElementById('intensityCanvas');
        const ictx = intensityCanvas.getContext('2d');

        // Set intensity canvas size
        intensityCanvas.width = intensityCanvas.offsetWidth || 700;
        intensityCanvas.height = 80;

        // Simulation state
        let isPlaying = false;
        let speed = 1;
        let mode = 'double'; // 'double', 'single', 'compare'
        let particleType = 'photon';
        let detectorActive = false;
        let showWaves = true;
        let showProbability = false;

        // Physics parameters
        let wavelength = 550;
        let slitDistance = 50;
        let slitWidth = 10;
        let emissionRate = 5;

        // Particles and detection
        let particles = [];
        let detectedPoints = [];
        let histogram = new Array(200).fill(0);
        let totalCount = 0;
        let slit1Count = 0;
        let slit2Count = 0;

        // Geometry
        const sourceX = 60;
        const slitX = 280;
        const screenX = 720;
        const centerY = mainCanvas.height / 2;

        let time = 0;
        let waveFronts = [];

        // Create quantum background
        function createQuantumBg() {
            const container = document.getElementById('quantumBg');
            for (let i = 0; i < 5; i++) {
                const wave = document.createElement('div');
                wave.className = 'quantum-wave';
                wave.style.width = '200px';
                wave.style.height = '200px';
                wave.style.left = Math.random() * 100 + '%';
                wave.style.top = Math.random() * 100 + '%';
                wave.style.animationDelay = i * 1.5 + 's';
                container.appendChild(wave);
            }
        }

        // Convert wavelength to RGB color
        function wavelengthToColor(wl, alpha = 1) {
            let r, g, b;
            if (wl >= 380 && wl < 440) {
                r = -(wl - 440) / (440 - 380); g = 0; b = 1;
            } else if (wl >= 440 && wl < 490) {
                r = 0; g = (wl - 440) / (490 - 440); b = 1;
            } else if (wl >= 490 && wl < 510) {
                r = 0; g = 1; b = -(wl - 510) / (510 - 490);
            } else if (wl >= 510 && wl < 580) {
                r = (wl - 510) / (580 - 510); g = 1; b = 0;
            } else if (wl >= 580 && wl < 645) {
                r = 1; g = -(wl - 645) / (645 - 580); b = 0;
            } else {
                r = 1; g = 0; b = 0;
            }
            return `rgba(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)}, ${alpha})`;
        }

        // Calculate interference intensity
        function getIntensity(y, slitMode = mode) {
            const d = slitDistance * 0.00001; // meters
            const b = slitWidth * 0.00001;
            const L = 0.5; // screen distance in meters
            const lambda = wavelength * 1e-9;
            const yOffset = (y - centerY) * 0.0001;

            const theta = Math.atan2(yOffset, L);
            const sinTheta = Math.sin(theta);

            // Single slit diffraction envelope
            const alpha = Math.PI * b * sinTheta / lambda;
            const singleSlit = alpha !== 0 ? Math.pow(Math.sin(alpha) / alpha, 2) : 1;

            if (slitMode === 'single' || detectorActive) {
                return singleSlit;
            }

            // Double slit interference
            const beta = Math.PI * d * sinTheta / lambda;
            const doubleSlit = Math.pow(Math.cos(beta), 2);

            return singleSlit * doubleSlit;
        }

        // Emit particle
        function emitParticle() {
            const color = particleType === 'photon' ? wavelengthToColor(wavelength) : 'rgba(66, 165, 245, 1)';

            // Sample from probability distribution
            let y;
            let attempts = 0;
            do {
                y = centerY + (Math.random() - 0.5) * 380;
                const intensity = getIntensity(y);
                if (Math.random() < intensity) break;
                attempts++;
            } while (attempts < 200);

            const whichSlit = Math.random() < 0.5 ? 1 : 2;

            particles.push({
                x: sourceX,
                y: centerY,
                targetY: y,
                color: color,
                slit: whichSlit,
                wavePhase: time,
                active: true
            });

            // Add wave front
            if (showWaves && !detectorActive) {
                waveFronts.push({
                    x: sourceX,
                    radius: 0,
                    phase: time,
                    fromSource: true
                });
            }
        }

        // Update particles
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                const moveSpeed = 5 * speed;

                if (p.x < slitX) {
                    p.x += moveSpeed;
                } else if (p.x < screenX) {
                    p.x += moveSpeed;
                    const progress = (p.x - slitX) / (screenX - slitX);
                    p.y = centerY + (p.targetY - centerY) * progress;

                    // Spawn wave fronts from slits
                    if (p.x === slitX + moveSpeed && showWaves && !detectorActive) {
                        const slit1Y = centerY - slitDistance;
                        const slit2Y = centerY + slitDistance;

                        if (mode !== 'single') {
                            waveFronts.push({ x: slitX, y: slit1Y, radius: 0, phase: time, fromSlit: 1 });
                            waveFronts.push({ x: slitX, y: slit2Y, radius: 0, phase: time, fromSlit: 2 });
                        } else {
                            waveFronts.push({ x: slitX, y: centerY, radius: 0, phase: time, fromSlit: 0 });
                        }
                    }
                } else {
                    // Hit screen
                    const screenY = Math.round(p.y);
                    detectedPoints.push({
                        x: screenX + 5 + Math.random() * 60,
                        y: screenY,
                        color: p.color,
                        age: 0
                    });

                    // Update histogram
                    const histIdx = Math.floor((screenY / mainCanvas.height) * histogram.length);
                    if (histIdx >= 0 && histIdx < histogram.length) {
                        histogram[histIdx]++;
                    }

                    totalCount++;
                    if (p.slit === 1) slit1Count++;
                    else slit2Count++;

                    updateStats();
                    particles.splice(i, 1);
                }
            }

            // Update wave fronts
            for (let i = waveFronts.length - 1; i >= 0; i--) {
                waveFronts[i].radius += 3 * speed;
                if (waveFronts[i].radius > 500) {
                    waveFronts.splice(i, 1);
                }
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('slit1Count').textContent = slit1Count;
            document.getElementById('slit2Count').textContent = slit2Count;
        }

        // Draw functions
        function drawBackground() {
            // Main background
            const grad = ctx.createLinearGradient(0, 0, mainCanvas.width, 0);
            grad.addColorStop(0, '#0a0a18');
            grad.addColorStop(0.3, '#08081a');
            grad.addColorStop(1, '#050515');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

            // Grid
            ctx.strokeStyle = 'rgba(171, 71, 188, 0.05)';
            ctx.lineWidth = 1;
            for (let x = 0; x < mainCanvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, mainCanvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < mainCanvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(mainCanvas.width, y);
                ctx.stroke();
            }
        }

        function drawSource() {
            // Outer glow
            const glow = ctx.createRadialGradient(sourceX, centerY, 0, sourceX, centerY, 40);
            const color = particleType === 'photon' ? wavelengthToColor(wavelength, 0.3) : 'rgba(66, 165, 245, 0.3)';
            glow.addColorStop(0, color);
            glow.addColorStop(1, 'transparent');
            ctx.fillStyle = glow;
            ctx.beginPath();
            ctx.arc(sourceX, centerY, 40, 0, Math.PI * 2);
            ctx.fill();

            // Core
            ctx.beginPath();
            ctx.arc(sourceX, centerY, 15, 0, Math.PI * 2);
            ctx.fillStyle = particleType === 'photon' ? wavelengthToColor(wavelength) : '#42a5f5';
            ctx.fill();

            // Pulse animation
            const pulseSize = 20 + Math.sin(time * 0.1) * 5;
            ctx.beginPath();
            ctx.arc(sourceX, centerY, pulseSize, 0, Math.PI * 2);
            ctx.strokeStyle = particleType === 'photon' ? wavelengthToColor(wavelength, 0.5) : 'rgba(66, 165, 245, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Label
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '11px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(particleType === 'photon' ? 'Lichtquelle' : 'e‚Åª Quelle', sourceX, centerY + 55);
        }

        function drawBarrier() {
            const slit1Y = centerY - slitDistance;
            const slit2Y = centerY + slitDistance;
            const halfWidth = slitWidth / 2;

            ctx.fillStyle = '#2a2a3a';

            if (mode === 'single') {
                // Single slit
                ctx.fillRect(slitX - 8, 0, 16, centerY - halfWidth);
                ctx.fillRect(slitX - 8, centerY + halfWidth, 16, mainCanvas.height - centerY - halfWidth);

                // Highlight slit
                ctx.strokeStyle = '#ab47bc';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(slitX, centerY - halfWidth);
                ctx.lineTo(slitX, centerY + halfWidth);
                ctx.stroke();
            } else {
                // Double slit
                ctx.fillRect(slitX - 8, 0, 16, slit1Y - halfWidth);
                ctx.fillRect(slitX - 8, slit1Y + halfWidth, 16, slit2Y - slit1Y - slitWidth);
                ctx.fillRect(slitX - 8, slit2Y + halfWidth, 16, mainCanvas.height - slit2Y - halfWidth);

                // Highlight slits
                ctx.strokeStyle = '#ab47bc';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(slitX, slit1Y - halfWidth);
                ctx.lineTo(slitX, slit1Y + halfWidth);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(slitX, slit2Y - halfWidth);
                ctx.lineTo(slitX, slit2Y + halfWidth);
                ctx.stroke();

                // Labels
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = '10px Inter';
                ctx.textAlign = 'right';
                ctx.fillText('Spalt 1', slitX - 15, slit1Y + 4);
                ctx.fillText('Spalt 2', slitX - 15, slit2Y + 4);
            }

            // Detector indicators
            if (detectorActive) {
                ctx.fillStyle = '#e74c3c';
                ctx.font = 'bold 10px Inter';
                ctx.textAlign = 'left';
                ctx.fillText('üîç', slitX + 15, slit1Y + 4);
                if (mode !== 'single') {
                    ctx.fillText('üîç', slitX + 15, slit2Y + 4);
                }
            }
        }

        function drawScreen() {
            // Screen background
            const screenGrad = ctx.createLinearGradient(screenX, 0, mainCanvas.width, 0);
            screenGrad.addColorStop(0, '#151525');
            screenGrad.addColorStop(1, '#0a0a15');
            ctx.fillStyle = screenGrad;
            ctx.fillRect(screenX, 0, mainCanvas.width - screenX, mainCanvas.height);

            // Show probability distribution
            if (showProbability) {
                for (let y = 0; y < mainCanvas.height; y += 2) {
                    const intensity = getIntensity(y);
                    const color = particleType === 'photon' ? wavelengthToColor(wavelength, intensity * 0.4) : `rgba(66, 165, 245, ${intensity * 0.4})`;
                    ctx.fillStyle = color;
                    ctx.fillRect(screenX, y, 70, 2);
                }
            }

            // Label
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.font = '11px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Detektorschirm', screenX + 35, 20);
        }

        function drawWaveFronts() {
            if (!showWaves) return;

            const color = particleType === 'photon' ? wavelengthToColor(wavelength, 0.15) : 'rgba(66, 165, 245, 0.15)';

            waveFronts.forEach(wf => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;

                if (wf.fromSource) {
                    ctx.beginPath();
                    ctx.arc(wf.x, centerY, wf.radius, -0.5, 0.5);
                    ctx.stroke();
                } else if (wf.fromSlit !== undefined) {
                    const slitY = wf.fromSlit === 1 ? centerY - slitDistance :
                                  wf.fromSlit === 2 ? centerY + slitDistance : centerY;
                    ctx.beginPath();
                    ctx.arc(slitX, slitY, wf.radius, -0.8, 0.8);
                    ctx.stroke();
                }
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                // Glow
                const glow = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 15);
                glow.addColorStop(0, p.color);
                glow.addColorStop(1, 'transparent');
                ctx.fillStyle = glow;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
                ctx.fill();

                // Core
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
        }

        function drawDetectedPoints() {
            detectedPoints.forEach(point => {
                const alpha = Math.max(0.2, 1 - point.age * 0.002);
                ctx.beginPath();
                ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = point.color.replace(/[\d.]+\)$/g, `${alpha})`);
                ctx.fill();
                point.age++;
            });
        }

        function drawIntensityGraph() {
            ictx.clearRect(0, 0, intensityCanvas.width, intensityCanvas.height);

            // Background
            ictx.fillStyle = 'rgba(0,0,0,0.5)';
            ictx.fillRect(0, 0, intensityCanvas.width, intensityCanvas.height);

            if (totalCount === 0) return;

            const maxVal = Math.max(...histogram, 1);
            const barWidth = intensityCanvas.width / histogram.length;

            // Draw histogram
            const color = particleType === 'photon' ? wavelengthToColor(wavelength, 0.8) : 'rgba(66, 165, 245, 0.8)';
            ictx.fillStyle = color;

            for (let i = 0; i < histogram.length; i++) {
                const height = (histogram[i] / maxVal) * (intensityCanvas.height - 10);
                ictx.fillRect(i * barWidth, intensityCanvas.height - height, barWidth - 1, height);
            }

            // Draw theoretical curve
            ictx.strokeStyle = 'rgba(255,255,255,0.5)';
            ictx.lineWidth = 1;
            ictx.beginPath();
            for (let i = 0; i < histogram.length; i++) {
                const y = (i / histogram.length) * mainCanvas.height;
                const intensity = getIntensity(y);
                const graphY = intensityCanvas.height - intensity * (intensityCanvas.height - 10);
                if (i === 0) ictx.moveTo(i * barWidth, graphY);
                else ictx.lineTo(i * barWidth, graphY);
            }
            ictx.stroke();
        }

        function draw() {
            drawBackground();
            drawWaveFronts();
            drawSource();
            drawBarrier();
            drawScreen();
            drawDetectedPoints();
            drawParticles();
        }

        function animate() {
            if (isPlaying) {
                // Emit particles
                const rate = emissionRate * speed;
                if (Math.random() < rate * 0.03) {
                    emitParticle();
                }

                updateParticles();
            }

            draw();
            drawIntensityGraph();

            time++;
            requestAnimationFrame(animate);
        }

        // Control functions
        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? '‚è∏ Pause' : '‚ñ∂ Starten';
        }

        function resetExperiment() {
            particles = [];
            detectedPoints = [];
            waveFronts = [];
            histogram = new Array(200).fill(0);
            totalCount = 0;
            slit1Count = 0;
            slit2Count = 0;
            updateStats();
        }

        function toggleDetector() {
            detectorActive = !detectorActive;
            const btn = document.getElementById('detectorBtn');
            btn.textContent = detectorActive ? 'üîç Detektor AUS' : 'üîç Detektor AN';
            btn.classList.toggle('active', detectorActive);
            document.getElementById('detectorAlert').classList.toggle('visible', detectorActive);

            // Update insight text
            const insight = document.getElementById('insightText');
            if (detectorActive) {
                insight.textContent = 'Der Detektor misst, durch welchen Spalt jedes Teilchen geht. ' +
                    'Das Interferenzmuster verschwindet! Die Wellenfunktion "kollabiert" und das Teilchen verh√§lt sich klassisch.';
            } else {
                insight.textContent = 'Einzelne Photonen erzeugen zuf√§llige Punkte auf dem Schirm. ' +
                    'Aber √ºber viele Teilchen entsteht ein Interferenzmuster ‚Äì als w√ºrde jedes Teilchen ' +
                    'gleichzeitig durch beide Spalte gehen!';
            }

            resetExperiment();
        }

        function toggleOption(option) {
            if (option === 'waves') {
                showWaves = !showWaves;
                document.getElementById('toggleWaves').classList.toggle('active', showWaves);
            } else if (option === 'probability') {
                showProbability = !showProbability;
                document.getElementById('toggleProbability').classList.toggle('active', showProbability);
            }
        }

        function setSpeed(s) {
            speed = s;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.textContent) === s);
            });
        }

        function setMode(newMode) {
            mode = newMode;
            resetExperiment();

            const insight = document.getElementById('insightText');
            if (mode === 'single') {
                insight.textContent = 'Mit nur einem Spalt entsteht ein einfaches Beugungsmuster. ' +
                    'Die Intensit√§t nimmt zur Mitte hin zu und zeigt Beugungsminima an den R√§ndern.';
            } else if (mode === 'compare') {
                insight.textContent = 'Vergleiche Einzelspalt und Doppelspalt: Das Interferenzmuster beim Doppelspalt ' +
                    'zeigt zus√§tzliche Maxima und Minima innerhalb der Beugungseinh√ºllenden.';
            } else {
                insight.textContent = 'Einzelne Photonen erzeugen zuf√§llige Punkte auf dem Schirm. ' +
                    'Aber √ºber viele Teilchen entsteht ein Interferenzmuster!';
            }
        }

        // Event listeners
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                setMode(btn.dataset.mode);
            });
        });

        document.querySelectorAll('.particle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.particle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                particleType = btn.dataset.particle;
                resetExperiment();
            });
        });

        document.getElementById('wavelength').addEventListener('input', (e) => {
            wavelength = parseInt(e.target.value);
            document.getElementById('wavelengthVal').textContent = wavelength + ' nm';
        });

        document.getElementById('slitDistance').addEventListener('input', (e) => {
            slitDistance = parseInt(e.target.value);
            document.getElementById('slitDistanceVal').textContent = (slitDistance * 0.01).toFixed(2) + ' mm';
        });

        document.getElementById('slitWidth').addEventListener('input', (e) => {
            slitWidth = parseInt(e.target.value);
            document.getElementById('slitWidthVal').textContent = (slitWidth * 0.01).toFixed(2) + ' mm';
        });

        document.getElementById('emissionRate').addEventListener('input', (e) => {
            emissionRate = parseInt(e.target.value);
            const labels = ['Minimal', 'Sehr langsam', 'Langsam', 'Mittel', 'Schnell', 'Sehr schnell'];
            document.getElementById('rateVal').textContent = labels[Math.min(5, Math.floor(emissionRate / 2))];
        });

        // Initialize
        createQuantumBg();
        animate();
    </script>
</body>
</html>
